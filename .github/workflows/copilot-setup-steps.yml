name: "Copilot Setup Steps"

# Automatically run the setup steps when they are changed to allow for easy validation, and
# allow manual testing through the repository's "Actions" tab
on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: ubuntu-latest

    # Set the permissions to the lowest permissions possible needed for your steps.
    # Copilot will be given its own token for its operations.
    permissions:
      # If you want to clone the repository as part of your setup steps, for example to install dependencies, you'll need the `contents: read` permission. If you don't clone the repository in your setup steps, Copilot will do this for you automatically after the steps complete.
      contents: write

    # You can define any steps you want, and they will run before the agent starts.
    # If you do not check out your code, Copilot will do this for you.
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SDKMAN
        run: |
          echo "ğŸ”§ Installing SDKMAN..."
          curl -s "https://get.sdkman.io" | bash
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          echo "âœ… SDKMAN installed successfully"

      - name: Install Kotlin
        run: |
          echo "ğŸ”§ Installing Kotlin..."
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          sdk install kotlin
          kotlin -version
          echo "âœ… Kotlin installed successfully"

      - name: Install Java
        run: |
          echo "â˜• Installing Java 21..."
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          sdk install java 21.0.7-tem
          java -version
          echo "âœ… Java installed successfully"

      - name: Install Gradle
        run: |
          echo "ğŸ˜ Installing Gradle..."
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          sdk install gradle
          gradle --version
          echo "âœ… Gradle installed successfully"

      - name: Create .env from .env.example if needed
        run: |
          if [ ! -f ".env" ] && [ -f ".env.example" ]; then
            echo "âš™ï¸  Creating .env from .env.example"
            cp .env.example .env
          fi

      - name: Build project
        run: |
          echo "ğŸ—ï¸ Building project..."
          ./gradlew build --no-daemon
          echo "âœ… Project built successfully"

      - name: Run tests
        run: |
          echo "ğŸ§ª Running tests..."
          ./gradlew test --no-daemon
          echo "âœ… Tests completed"

      - name: Setup complete
        run: echo "ğŸ‰ All dependencies are in placeâ€”network can go dark now. Happy coding!"